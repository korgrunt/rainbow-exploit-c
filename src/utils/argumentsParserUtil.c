#include "../utils/stringUtil.h"
#include "../types/argumentsParsed.h"
#include "../enums/boolean.h"
#include "../enums/execMode.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <openssl/sha.h>
#include <openssl/md5.h>


Algorythme strToAlgorythme(char *str)
{
  if (areStrEquals(str, "MD5"))
    return HASH_MD5;

  if (areStrEquals(str, "SHA_1"))
    return SHA_1;

  if (areStrEquals(str, "SHA_256"))
    return SHA_256;

  if (areStrEquals(str, "SHA_512"))
    return SHA_512;

  return SHA_256; //default
}

char * algorythmeToStr(Algorythme algo)
{
  if (HASH_MD5 == algo)
    return "MD5";

  if (SHA_1 == algo)
    return "SHA_1";

  if (SHA_256 == algo)
    return "SHA_256";

  if (SHA_512 == algo)
    return "SHA_512";

  return "UNKNOW"; //default
}

int algoToByteLength(Algorythme algo)
{
  if (algo == HASH_MD5)
    return MD5_DIGEST_LENGTH;

  if (algo == SHA_1)
    return SHA_DIGEST_LENGTH;

  if (algo == SHA_256)
    return SHA256_DIGEST_LENGTH;

  if (algo == SHA_512)
    return SHA512_DIGEST_LENGTH;

  return 32; //default
}

ArgumentsParsed *parseArgument(int argCount, char **argValues)
{
  ArgumentsParsed *argsParsed = malloc(sizeof(ArgumentsParsed));

  argsParsed->algorythme = SHA_256; // DEFAULT ALGORYTHME USED IF NOT PROVIDED IN ARGUMENTS
  argsParsed->execMode = UNKNOW;
  argsParsed->inputFilename = NULL;
  argsParsed->outputFilename = NULL;
  argsParsed->isValid = FALSE;
  argsParsed->threadsCount = 1;

  for (int i = 1; i < argCount; i++)
  {

    if (areStrEquals(argValues[i], "-G") == TRUE)
      argsParsed->execMode = MODE_G;

    if (areStrEquals(argValues[i], "-C") == TRUE)
      argsParsed->execMode = MODE_C;

    if (areStrEquals(argValues[i], "-L") == TRUE)
      argsParsed->execMode = MODE_L;

    if (areStrEquals(argValues[i], "-o") == TRUE && i + 1 < argCount)
      argsParsed->outputFilename = argValues[i + 1];

    if (areStrEquals(argValues[i], "-i") == TRUE && i + 1 < argCount)
      argsParsed->inputFilename = argValues[i + 1];

    if (areStrEquals(argValues[i], "--algorithm") == TRUE && i + 1 < argCount)
      argsParsed->algorythme = strToAlgorythme(argValues[i + 1]);
   
    if (areStrEquals(argValues[i], "--threads") == TRUE && i + 1 < argCount)
      argsParsed->threadsCount = atoi(argValues[i + 1]);

  }

  argsParsed->hashBytesLength = algoToByteLength(argsParsed->algorythme);
  
  // check if MODE_G has outputfilename, not forced to have an inputfilename cause we can use stdin
  argsParsed->isValid = (argsParsed->execMode == MODE_G || argsParsed->execMode == MODE_C) && argsParsed->outputFilename != NULL ? TRUE : argsParsed->isValid;
  // check if MODE_L has inputfilename, not forced to have an outputfilename cause we can use stdout
  argsParsed->isValid = argsParsed->execMode == MODE_L && argsParsed->inputFilename != NULL ? TRUE : argsParsed->isValid;
  return argsParsed;
};

void freeArgParsed(ArgumentsParsed *parsedArgument)
{
  free(parsedArgument);
}